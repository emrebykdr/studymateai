<Page x:Class="StudyMateAI.Views.DocumentsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      xmlns:wpf="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:helpers="clr-namespace:StudyMateAI.Helpers"
      TextElement.Foreground="{DynamicResource MaterialDesignBody}"
      Title="Dökümanlar">
    
    <Page.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard>
                <Storyboard>
                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                   From="0" To="1" Duration="0:0:0.4"
                                   EasingFunction="{StaticResource EaseOut}"/>
                </Storyboard>
            </BeginStoryboard>
        </EventTrigger>
    </Page.Triggers>
    
    <Page.Resources>
        <helpers:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    </Page.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="1.5*"/> <!-- Top: PDF Viewer (Reduced) -->
            <RowDefinition Height="*"/>    <!-- Bottom: Lists & Info -->
        </Grid.RowDefinitions>

        <!-- Row 0: PDF Viewer Area (Full Width) -->
        <Grid Grid.Row="0" Margin="16,16,16,0">
             <!-- Show always, or placeholder if not visible -->
            <Grid>
                <Grid.Style>
                    <Style TargetType="Grid">
                         <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsPdfViewerVisible}" Value="True">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>
                <wpf:WebView2 x:Name="PdfViewer" Source="{Binding PdfSource}" />
            </Grid>
            
            <!-- Placeholder when NO PDF is open -->
            <StackPanel HorizontalAlignment="Center" 
                       VerticalAlignment="Center">
                <StackPanel.Style>
                    <Style TargetType="StackPanel">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsPdfViewerVisible}" Value="True">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </StackPanel.Style>
                 <materialDesign:PackIcon Kind="FilePdfBox" Width="80" Height="80" Opacity="0.3" HorizontalAlignment="Center"
                                         Foreground="{StaticResource CyberTealBrush}"/>
                <TextBlock Text="PDF Görüntüleyici" 
                          Style="{StaticResource H2}"
                          HorizontalAlignment="Center"
                          Margin="0,16,0,8"/>
                <TextBlock Text="Bir döküman seçin" 
                          Style="{StaticResource Subtitle}"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Row 1: Bottom Content Area -->
        <Grid Grid.Row="1" Margin="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="260"/> <!-- Left: Doc List (Green) -->
                <ColumnDefinition Width="*"/>   <!-- Right: Info + AI (Purple + Yellow) -->
            </Grid.ColumnDefinitions>

            <!-- Left Panel - Document List -->
            <Grid Grid.Column="0" Margin="0,0,16,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <TextBlock Grid.Row="0" 
                          Text="Dökümanlarım" 
                          Style="{StaticResource H2}"/>

                <!-- Course Filter -->
                <!-- Folder Selection & Add/Delete -->
                <Grid Grid.Row="1" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <ComboBox Grid.Column="0"
                              ItemsSource="{Binding Folders}"
                              SelectedItem="{Binding SelectedFolder}"
                              DisplayMemberPath="Name"
                              Style="{DynamicResource MaterialDesignFilledComboBox}"
                              materialDesign:HintAssist.Hint="Klasör Seç"
                              Margin="0,0,8,0"
                              Background="#1E293B"
                              Foreground="{StaticResource CyberTealBrush}"
                              BorderBrush="#334155"
                              materialDesign:TextFieldAssist.UnderlineBrush="{StaticResource CyberTealBrush}"
                              materialDesign:HintAssist.Foreground="{DynamicResource MaterialDesignBody}">
                        <ComboBox.Resources>
                            <SolidColorBrush x:Key="MaterialDesignPaper" Color="#1E293B"/>
                            <SolidColorBrush x:Key="MaterialDesignBody" Color="White"/>
                        </ComboBox.Resources>
                    </ComboBox>
                    
                    <!-- Add Folder Button -->
                    <Button Grid.Column="1"
                            Command="{Binding AddFolderCommand}"
                            Padding="8,4"
                            Margin="0,0,4,0"
                            ToolTip="Yeni Klasör Ekle"
                            Background="#1E293B"
                            BorderBrush="#334155"
                            BorderThickness="1">
                         <materialDesign:PackIcon Kind="FolderPlus" Width="20" Height="20"/>
                    </Button>

                    <!-- Delete Folder Button -->
                    <Button Grid.Column="2"
                            Command="{Binding DeleteFolderCommand}"
                            Padding="8,4"
                            Background="#7F1D1D"
                            BorderBrush="#991B1B"
                            BorderThickness="1"
                            ToolTip="Klasörü Sil">
                         <materialDesign:PackIcon Kind="Delete" Width="20" Height="20"/>
                    </Button>
                </Grid>
                
                <Grid Grid.Row="1" Margin="0,0,0,8" Visibility="Collapsed"> <!-- Hiding Delete for now or just put it in the grid above if needed. -->
                </Grid>

                <!-- Search Box -->
                <TextBox Grid.Row="2"
                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                        Style="{DynamicResource MaterialDesignOutlinedTextBox}"
                        materialDesign:HintAssist.Hint="Döküman ara..."
                        materialDesign:TextFieldAssist.HasClearButton="True"
                        Margin="0,0,0,16"
                        Background="#1E293B"
                        Foreground="White"
                        CaretBrush="White"
                        BorderBrush="#334155"
                        materialDesign:HintAssist.Foreground="{DynamicResource MaterialDesignBody}">
                    <TextBox.Resources>
                        <Style TargetType="Border">
                            <Setter Property="CornerRadius" Value="8"/>
                        </Style>
                    </TextBox.Resources>
                </TextBox>

                <!-- Document List -->
                <ListBox Grid.Row="3"
                        ItemsSource="{Binding Documents}"
                        SelectedItem="{Binding SelectedDocument}"
                        ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                        HorizontalContentAlignment="Stretch"
                        Background="Transparent"
                        BorderThickness="0">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <materialDesign:Card Margin="0,0,0,8" Padding="8" Background="#1E293B">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <materialDesign:PackIcon Grid.Column="0"
                                                            Kind="FileDocument"
                                                            Width="24"
                                                            Height="24"
                                                            VerticalAlignment="Center"
                                                            Margin="0,0,8,0"
                                                            Foreground="{DynamicResource PrimaryHueMidBrush}"/>

                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="{Binding FileName}"
                                                 FontWeight="SemiBold"
                                                 FontSize="12"
                                                 TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                </Grid>
                            </materialDesign:Card>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <!-- Action Buttons -->
                <StackPanel Grid.Row="4" Orientation="Horizontal" Margin="0,16,0,0">
                    <Button Command="{Binding UploadDocumentCommand}"
                           Margin="0,0,8,0" Padding="8,4"
                           Background="#1E293B"
                           BorderBrush="#334155"
                           BorderThickness="1">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Upload" Margin="0,0,4,0"/>
                            <TextBlock Text="Yükle"/>
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding DeleteDocumentCommand}"
                           Background="#1E293B"
                           BorderBrush="#991B1B"
                           BorderThickness="1"
                           Padding="8,4"
                           Foreground="#FCA5A5">
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="Delete" Margin="0,0,4,0"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- Right Panel - Info & AI -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>   <!-- Info & Content (Purple) -->
                    <RowDefinition Height="200"/> <!-- AI Analysis (Yellow) - Reduced height as total space is shared -->
                </Grid.RowDefinitions>

                <!-- Document Info & Text Content (Purple) -->
                <Grid Grid.Row="0" Margin="0,0,0,16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header/Info -->
                      <materialDesign:Card Grid.Row="0" Padding="16" Margin="0,0,0,16" Background="#1E293B">
                          <StackPanel>
                            <TextBlock Text="{Binding SelectedDocument.FileName}" FontSize="18" FontWeight="Bold"/>
                              <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                <Button Command="{Binding ViewPdfCommand}" Height="28" Padding="8,0"
                                        Background="#1E293B"
                                        BorderBrush="#334155"
                                        BorderThickness="1">
                                    <StackPanel Orientation="Horizontal">
                                          <materialDesign:PackIcon Kind="Eye" Margin="0,0,4,0"/>
                                        <TextBlock Text="PDF Aç/Kapat"/>
                                    </StackPanel>
                                </Button>
                                
                                <!-- Move to Folder Combo REMOVED -->

                              </StackPanel>
                          </StackPanel>
                      </materialDesign:Card>

                    <!-- Text Content -->
                    <materialDesign:Card Grid.Row="1" VerticalAlignment="Stretch" Background="#1E293B" UniformCornerRadius="8">
                          <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel>
                                <TextBlock Text="Döküman İçeriği (Metin)" FontWeight="Bold" Margin="0,0,0,8" Foreground="{DynamicResource CyanGeometricBrush}"/>
                                <TextBox Text="{Binding SelectedDocument.Content}" 
                                         TextWrapping="Wrap" 
                                         FontFamily="Consolas" 
                                         IsReadOnly="True" 
                                         Background="Transparent" 
                                         Foreground="#E2E8F0"
                                         BorderThickness="0"/>
                            </StackPanel>
                        </ScrollViewer>
                    </materialDesign:Card>
                </Grid>

                <!-- AI Analysis (Yellow) -->
                <Grid Grid.Row="1">
                      <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <materialDesign:Card Grid.Row="0" Margin="0,0,0,8" VerticalAlignment="Stretch" Background="{DynamicResource SlateDarkBrush}" BorderBrush="{DynamicResource GlassBorderBrush}" BorderThickness="1">
                        <TabControl Background="Transparent" Foreground="{DynamicResource MaterialDesignBody}">
                            <TabControl.Resources>
                                <Style TargetType="TabItem" BasedOn="{StaticResource {x:Type TabItem}}">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Setter Property="Foreground" Value="{StaticResource MaterialDesignBody}"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource CyberTealBrush}"/>
                                            <Setter Property="Background" Value="#1E293B"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </TabControl.Resources>
                            
                            <!-- Tab 1: Summary -->
                            <TabItem Header="Özet">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,4,16,0">
                                         <Button Command="{Binding ViewSummaryPdfCommand}" ToolTip="Görüntüle (PDF Olarak)" Padding="4" Height="32" Width="32" Background="Transparent" BorderThickness="0">
                                             <materialDesign:PackIcon Kind="Eye" Width="24" Height="24" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                         </Button>
                                         <Button Command="{Binding SaveSummaryPdfCommand}" ToolTip="PDF Olarak Kaydet" Padding="4" Height="32" Width="32" Background="Transparent" BorderThickness="0">
                                             <materialDesign:PackIcon Kind="FilePdfBox" Width="24" Height="24" Foreground="Red"/>
                                         </Button>
                                    </StackPanel>
                                    <ScrollViewer Grid.Row="1" Padding="16">
                                        <TextBlock Text="{Binding Summary}" TextWrapping="Wrap" FontSize="14" Foreground="{DynamicResource StarlightBrush}" LineHeight="22"/>
                                    </ScrollViewer>
                                </Grid>
                            </TabItem>

                            <!-- Tab 2: Keywords -->
                            <TabItem Header="Anahtar Kelimeler">
                                <ScrollViewer Padding="16">
                                    <ItemsControl ItemsSource="{Binding Keywords}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <materialDesign:Chip Content="{Binding}" Margin="0,0,8,8"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </TabItem>

                            <!-- Tab 3: User Notes -->
                            <TabItem Header="Kendi Notlarım">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBox Grid.Row="0"
                                             Text="{Binding UserNotes, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{DynamicResource MaterialDesignOutlinedTextBox}"
                                             AcceptsReturn="True"
                                             TextWrapping="Wrap"
                                             VerticalScrollBarVisibility="Auto"
                                             Padding="16"
                                             Margin="8"
                                             materialDesign:HintAssist.Hint="Buraya kendi notlarınızı alabilirsiniz..."
                                             materialDesign:HintAssist.Foreground="{DynamicResource MaterialDesignBody}"
                                             VerticalAlignment="Stretch"
                                             Height="Auto"
                                             Background="#1E293B"
                                             Foreground="White"
                                             CaretBrush="White"/>

                                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,16,16">
                                        <Button Command="{Binding ViewUserNotesPdfCommand}" ToolTip="Görüntüle (PDF Olarak)" Padding="4" Height="32" Width="32" Background="Transparent" BorderThickness="0" Margin="0,0,8,0">
                                            <materialDesign:PackIcon Kind="Eye" Width="24" Height="24" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                        </Button>
                                        <Button Command="{Binding SaveUserNotesPdfCommand}" ToolTip="PDF Olarak Kaydet" Padding="4" Height="32" Width="32" Background="Transparent" BorderThickness="0" Margin="0,0,16,0">
                                            <materialDesign:PackIcon Kind="FilePdfBox" Width="24" Height="24" Foreground="Red"/>
                                        </Button>
                                        <Button Command="{Binding SaveUserNotesCommand}"
                                                Content="Notları Kaydet"
                                                Style="{DynamicResource {x:Type Button}}"/>
                                    </StackPanel>
                                </Grid>
                            </TabItem>


                            <!-- Tab 4: General Analysis -->
                            <TabItem Header="Genel Analiz">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,4,16,0">
                                         <Button Command="{Binding ViewAnalysisPdfCommand}" ToolTip="Görüntüle (PDF Olarak)" Padding="4" Height="32" Width="32" Background="Transparent" BorderThickness="0">
                                             <materialDesign:PackIcon Kind="Eye" Width="24" Height="24" Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                         </Button>
                                         <Button Command="{Binding SaveAnalysisPdfCommand}" ToolTip="PDF Olarak Kaydet" Padding="4" Height="32" Width="32" Background="Transparent" BorderThickness="0">
                                             <materialDesign:PackIcon Kind="FilePdfBox" Width="24" Height="24" Foreground="Red"/>
                                         </Button>
                                    </StackPanel>
                                    <ScrollViewer Grid.Row="1" Padding="16">
                                        <TextBlock Text="{Binding AnalysisResult}" TextWrapping="Wrap" Foreground="{DynamicResource StarlightBrush}" LineHeight="20"/>
                                    </ScrollViewer>
                                </Grid>
                            </TabItem>

                        </TabControl>
                    </materialDesign:Card>

                    <Button Grid.Row="1" Command="{Binding AnalyzeDocumentCommand}" Content="YAPAY ZEKA İLE ANALİZ ET" Style="{DynamicResource NeonGlowButton}" Margin="0,8,0,0" Height="45"/>
                </Grid>
            </Grid>
        </Grid>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="2" Background="#AA000000">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsLoading}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>

            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar Value="0"
                           IsIndeterminate="True"
                           Width="64"
                           Height="64"/>
                <TextBlock Text="AI analiz ediyor..."
                         Foreground="White"
                         FontSize="16"
                         Margin="0,16,0,0"
                         HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
